/*! indexeddbshim - v0.1.2 - 2015-04-03 */

"use strict";var idbModules={util:{}},cleanInterface=!1;!function(){var a={test:!0};if(Object.defineProperty)try{Object.defineProperty(a,"test",{enumerable:!1}),a.test&&(cleanInterface=!0)}catch(b){}}(),function(a){function b(a,b,c){c.target=b,"function"==typeof b[a]&&b[a].apply(b,[c])}var c=function(){this.length=0,this._items=[],cleanInterface&&Object.defineProperty(this,"_items",{enumerable:!1})};if(c.prototype={contains:function(a){return-1!==this._items.indexOf(a)},item:function(a){return this._items[a]},indexOf:function(a){return this._items.indexOf(a)},push:function(a){this._items.push(a),this.length+=1;for(var b=0;b<this._items.length;b++)this[b]=this._items[b]},splice:function(){this._items.splice.apply(this._items,arguments),this.length=this._items.length;for(var a in this)a===String(parseInt(a,10))&&delete this[a];for(a=0;a<this._items.length;a++)this[a]=this._items[a]}},cleanInterface)for(var d in{indexOf:!1,push:!1,splice:!1})Object.defineProperty(c.prototype,d,{enumerable:!1});a.util.callback=b,a.util.StringList=c,a.util.quote=function(a){return'"'+a+'"'}}(idbModules),function(idbModules){var Sca=function(){return{decycle:function(object,callback){function checkForCompletion(){0===queuedObjects.length&&returnCallback(derezObj)}function readBlobAsDataURL(a,b){var c=new FileReader;c.onloadend=function(c){var d=c.target.result,e="blob";a instanceof File,updateEncodedBlob(d,b,e)},c.readAsDataURL(a)}function updateEncodedBlob(dataURL,path,blobtype){var encoded=queuedObjects.indexOf(path);path=path.replace("$","derezObj"),eval(path+'.$enc="'+dataURL+'"'),eval(path+'.$type="'+blobtype+'"'),queuedObjects.splice(encoded,1),checkForCompletion()}function derez(a,b){var c,d,e;if(!("object"!=typeof a||null===a||a instanceof Boolean||a instanceof Date||a instanceof Number||a instanceof RegExp||a instanceof Blob||a instanceof String)){for(c=0;c<objects.length;c+=1)if(objects[c]===a)return{$ref:paths[c]};if(objects.push(a),paths.push(b),"[object Array]"===Object.prototype.toString.apply(a))for(e=[],c=0;c<a.length;c+=1)e[c]=derez(a[c],b+"["+c+"]");else{e={};for(d in a)Object.prototype.hasOwnProperty.call(a,d)&&(e[d]=derez(a[d],b+"["+JSON.stringify(d)+"]"))}return e}return a instanceof Blob?(queuedObjects.push(b),readBlobAsDataURL(a,b)):a instanceof Boolean?a={$type:"bool",$enc:a.toString()}:a instanceof Date?a={$type:"date",$enc:a.getTime()}:a instanceof Number?a={$type:"num",$enc:a.toString()}:a instanceof RegExp&&(a={$type:"regex",$enc:a.toString()}),a}var objects=[],paths=[],queuedObjects=[],returnCallback=callback,derezObj=derez(object,"$");checkForCompletion()},retrocycle:function retrocycle($){function dataURLToBlob(a){var b,c,d,e=";base64,";if(-1===a.indexOf(e))return c=a.split(","),b=c[0].split(":")[1],d=c[1],new Blob([d],{type:b});c=a.split(e),b=c[0].split(":")[1],d=window.atob(c[1]);for(var f=d.length,g=new Uint8Array(f),h=0;f>h;++h)g[h]=d.charCodeAt(h);return new Blob([g.buffer],{type:b})}function rez(value){var i,item,name,path;if(value&&"object"==typeof value)if("[object Array]"===Object.prototype.toString.apply(value))for(i=0;i<value.length;i+=1)item=value[i],item&&"object"==typeof item&&(path=item.$ref,value[i]="string"==typeof path&&px.test(path)?eval(path):rez(item));else if(void 0!==value.$type)switch(value.$type){case"blob":case"file":value=dataURLToBlob(value.$enc);break;case"bool":value=Boolean("true"===value.$enc);break;case"date":value=new Date(value.$enc);break;case"num":value=Number(value.$enc);break;case"regex":value=eval(value.$enc)}else for(name in value)"object"==typeof value[name]&&(item=value[name],item&&(path=item.$ref,value[name]="string"==typeof path&&px.test(path)?eval(path):rez(item)));return value}var px=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return rez($),$},encode:function(a,b){function c(a){b(JSON.stringify(a))}this.decycle(a,c)},decode:function(a){return this.retrocycle(JSON.parse(a))}}}();idbModules.Sca=Sca}(idbModules),function(idbModules){function validateKey(a){var b=typeof a;if("string"===b||"number"===b||a instanceof Date)return!0;if(!(a instanceof Array))throw idbModules.util.createDOMException("DataError","Not a valid key");for(var c=0;c<a.length;c++)validateKey(a[c])}function getKeyPath(value,keyPath){try{return eval("value."+keyPath)}catch(e){return void 0}}function setKeyPath(a,b,c){for(var d=b.split("."),e=0;e<d.length-1;e++){var f=d[e];a=a[f]=a[f]||{}}a[d[d.length-1]]=c}var collations=["","number","string","boolean","object","undefined"],getGenericEncoder=function(){return{encode:function(a){return collations.indexOf(typeof a)+"-"+JSON.stringify(a)},decode:function(a){return"undefined"==typeof a?void 0:JSON.parse(a.substring(2))}}},types={number:getGenericEncoder("number"),"boolean":getGenericEncoder(),object:getGenericEncoder(),string:{encode:function(a){return collations.indexOf("string")+"-"+a},decode:function(a){return""+a.substring(2)}},undefined:{encode:function(){return collations.indexOf("undefined")+"-undefined"},decode:function(){return void 0}}};idbModules.Key={encode:function(a){return types[typeof a].encode(a)},encodeKey:function(a){return validateKey(a),types[typeof a].encode(a)},decode:function(a){return types[collations[a.substring(0,1)]].decode(a)},getKeyPath:getKeyPath,setKeyPath:setKeyPath}}(idbModules),function(a){function b(a,b){var c=new Event(a);return c.debug=b,Object.defineProperty(c,"target",{writable:!0}),c}function c(a,b){this.type=a,this.debug=b,this.bubbles=!1,this.cancelable=!1,this.eventPhase=0,this.timeStamp=(new Date).valueOf()}var d=!1;try{var e=b("test type","test debug"),f={test:"test target"};e.target=f,e instanceof Event&&"test type"===e.type&&"test debug"===e.debug&&e.target===f&&(d=!0)}catch(g){}d?(a.Event=Event,a.IDBVersionChangeEvent=Event,a.util.createEvent=b):(a.Event=c,a.IDBVersionChangeEvent=c,a.util.createEvent=function(a,b){return new c(a,b)})}(idbModules),function(a){function b(a,b){var c=new DOMException.prototype.constructor(0,b);return c.name=a||"DOMException",c.message=b,c}function c(a,b){a=a||"DOMError";var c=new DOMError(a,b);return c.name===a||(c.name=a),c.message===b||(c.message=b),c}function d(a,b){var c=new Error(b);return c.name=a||"DOMException",c.message=b,c}function e(b,c,d){if(a.DEBUG){d&&d.message&&(d=d.message);var e="function"==typeof console.error?"error":"log";console[e](b+": "+c+". "+(d||"")),console.trace&&console.trace()}}var f,g=!1,h=!1;try{f=b("test name","test message"),f instanceof DOMException&&"test name"===f.name&&"test message"===f.message&&(g=!0)}catch(i){}try{f=c("test name","test message"),f instanceof DOMError&&"test name"===f.name&&"test message"===f.message&&(h=!0)}catch(i){}a.util.logError=e,g?(a.DOMException=DOMException,a.util.createDOMException=function(a,c,d){return e(a,c,d),b(a,c)}):(a.DOMException=Error,a.util.createDOMException=function(a,b,c){return e(a,b,c),d(a,b)}),h?(a.DOMError=DOMError,a.util.createDOMError=function(a,b,d){return e(a,b,d),c(a,b)}):(a.DOMError=Error,a.util.createDOMError=function(a,b,c){return e(a,b,c),d(a,b)})}(idbModules),function(a){function b(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null,this.readyState="pending"}function c(){this.onblocked=this.onupgradeneeded=null}c.prototype=new b,c.prototype.constructor=c,a.IDBRequest=b,a.IDBOpenDBRequest=c}(idbModules),function(a,b){function c(a,b,c,d){this.lower=a,this.upper=b,this.lowerOpen=c,this.upperOpen=d}c.only=function(a){return new c(a,a,!1,!1)},c.lowerBound=function(a,d){return new c(a,b,d,b)},c.upperBound=function(a,d){return new c(b,a,b,d)},c.bound=function(a,b,d,e){return new c(a,b,d,e)},a.IDBKeyRange=c}(idbModules),function(a,b){function c(c,d,e,f,g,h){if(!c||c instanceof a.IDBKeyRange||(c=new a.IDBKeyRange(c,c,!1,!1)),this.__range=c,this.source=this.__idbObjectStore=e,this.__req=f,this.key=b,this.direction=d,this.__keyColumnName=g,this.__valueColumnName=h,this.__valueDecoder="value"===h?a.Sca:a.Key,!this.source.transaction.__active)throw a.util.createDOMException("TransactionInactiveError","The transaction this IDBObjectStore belongs to is not active.");this.__offset=-1,this.__lastKeyContinued=b,this["continue"]()}c.prototype.__find=function(c,d,e,f,g){g=g||1;var h=this,i=["SELECT * FROM ",a.util.quote(h.__idbObjectStore.name)],j=[];i.push("WHERE ",h.__keyColumnName," NOT NULL"),!h.__range||h.__range.lower===b&&h.__range.upper===b||(i.push("AND"),h.__range.lower!==b&&(i.push(h.__keyColumnName+(h.__range.lowerOpen?" >":" >= ")+" ?"),j.push(a.Key.encode(h.__range.lower))),h.__range.lower!==b&&h.__range.upper!==b&&i.push("AND"),h.__range.upper!==b&&(i.push(h.__keyColumnName+(h.__range.upperOpen?" < ":" <= ")+" ?"),j.push(a.Key.encode(h.__range.upper)))),"undefined"!=typeof c&&(h.__lastKeyContinued=c,h.__offset=0),h.__lastKeyContinued!==b&&(i.push("AND "+h.__keyColumnName+" >= ?"),j.push(a.Key.encode(h.__lastKeyContinued)));var k="prev"===h.direction||"prevunique"===h.direction?"DESC":"ASC";i.push("ORDER BY ",h.__keyColumnName," "+k),i.push("LIMIT "+g+" OFFSET "+h.__offset),a.DEBUG&&console.log(i.join(" "),j),h.__prefetchedData=null,d.executeSql(i.join(" "),j,function(c,d){d.rows.length>1?(h.__prefetchedData=d.rows,h.__prefetchedIndex=0,a.DEBUG&&console.log("Preloaded "+h.__prefetchedData.length+" records for cursor"),h.__decode(d.rows.item(0),e)):1===d.rows.length?h.__decode(d.rows.item(0),e):(a.DEBUG&&console.log("Reached end of cursors"),e(b,b))},function(b,c){a.DEBUG&&console.log("Could not execute Cursor.continue"),f(c)})},c.prototype.__decode=function(b,c){var d=a.Key.decode(b[this.__keyColumnName]),e=this.__valueDecoder.decode(b[this.__valueColumnName]),f=a.Key.decode(b.key);c(d,e,f)},c.prototype["continue"]=function(c){var d=a.cursorPreloadPackSize||100,e=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(a,f,g,h){e.__offset++;var i=function(a,c,d){e.key=a,e.value=c,e.primaryKey=d,g("undefined"!=typeof e.key?e:b,e.__req)};return e.__prefetchedData&&(e.__prefetchedIndex++,e.__prefetchedIndex<e.__prefetchedData.length)?void e.__decode(e.__prefetchedData.item(e.__prefetchedIndex),i):void e.__find(c,a,i,h,d)})},c.prototype.advance=function(c){if(0>=c)throw a.util.createDOMException("Type Error","Count is invalid - 0 or negative",c);var d=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(a,e,f,g){d.__offset+=c,d.__find(b,a,function(a,c){d.key=a,d.value=c,f("undefined"!=typeof d.key?d:b,d.__req)},g)})},c.prototype.update=function(c){var d=this;d.__idbObjectStore.transaction.__assertWritable();var e=this.__idbObjectStore.transaction.__createRequest(function(){});return a.Sca.encode(c,function(f){d.__idbObjectStore.transaction.__pushToQueue(e,function(e,g,h,i){d.__find(b,e,function(b,g,j){var k=d.__idbObjectStore,l=d.__idbObjectStore.transaction.db.__storeProperties,m=[f],n="UPDATE "+a.util.quote(k.name)+" SET value = ?",o=l[k.name]&&l[k.name].indexList;if(o)for(var p in o){var q=o[p];n+=", "+p+" = ?",m.push(a.Key.encode(c[q.keyPath]))}n+=" WHERE key = ?",m.push(a.Key.encode(j)),a.DEBUG&&console.log(n,f,b,j),e.executeSql(n,m,function(a,c){d.__prefetchedData=null,1===c.rowsAffected?h(b):i("No rows with key found"+b)},function(a,b){i(b)})},i)})}),e},c.prototype["delete"]=function(){var c=this;return c.__idbObjectStore.transaction.__assertWritable(),this.__idbObjectStore.transaction.__addToTransactionQueue(function(d,e,f,g){c.__find(b,d,function(e,h,i){var j="DELETE FROM  "+a.util.quote(c.__idbObjectStore.name)+" WHERE key = ?";a.DEBUG&&console.log(j,e,i),d.executeSql(j,[a.Key.encode(i)],function(a,d){c.__prefetchedData=null,1===d.rowsAffected?(c.__offset--,f(b)):g("No rows with key found"+e)},function(a,b){g(b)})},g)})},a.IDBCursor=c}(idbModules),function(a,b){function c(a,b){this.indexName=this.name=a,this.__idbObjectStore=this.objectStore=this.source=b;var c=b.transaction.db.__storeProperties[b.name],d=c&&c.indexList;this.keyPath=d&&d[a]&&d[a].keyPath||a,["multiEntry","unique"].forEach(function(b){this[b]=!!(d&&d[a]&&d[a].optionalParams&&d[a].optionalParams[b])},this)}c.prototype.__createIndex=function(b,c,d){var e=this,f=e.__idbObjectStore.transaction;f.__addToTransactionQueue(function(f,g,h,i){e.__idbObjectStore.__getStoreProps(f,function(){function g(c,d){i(a.util.createDOMException(0,'Could not create index "'+b+'"',d))}var j=JSON.parse(e.__idbObjectStore.__storeProps.indexList);"undefined"!=typeof j[b]&&i(a.util.createDOMException(0,'Index "'+b+'" already exists on store "'+e.__idbObjectStore.name+'"',j));var k=b;j[b]={columnName:k,keyPath:c,optionalParams:d},e.__idbObjectStore.__storeProps.indexList=JSON.stringify(j);var l=["ALTER TABLE",a.util.quote(e.__idbObjectStore.name),"ADD",a.util.quote(k),"BLOB"].join(" ");a.DEBUG&&console.log(l),f.executeSql(l,[],function(b){b.executeSql("SELECT * FROM "+a.util.quote(e.__idbObjectStore.name),[],function(b,d){!function f(i){if(i<d.rows.length)try{var j=a.Sca.decode(d.rows.item(i).value),l=a.Key.getKeyPath(j,c);b.executeSql("UPDATE "+a.util.quote(e.__idbObjectStore.name)+" set "+a.util.quote(k)+" = ? where key = ?",[a.Key.encode(l),d.rows.item(i).key],function(){f(i+1)},g)}catch(m){f(i+1)}else a.DEBUG&&console.log("Updating the indexes in table",e.__idbObjectStore.__storeProps),b.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[e.__idbObjectStore.__storeProps.indexList,e.__idbObjectStore.name],function(){e.__idbObjectStore.__setReadyState("createIndex",!0),h(e)},g)}(0)},g)},g)},"createObjectStore")})},c.prototype.openCursor=function(b,c){{var d=new a.IDBRequest;new a.IDBCursor(b,c,this.source,d,this.indexName,"value")}return d},c.prototype.openKeyCursor=function(b,c){{var d=new a.IDBRequest;new a.IDBCursor(b,c,this.source,d,this.indexName,"key")}return d},c.prototype.__fetchIndexData=function(c,d){var e,f=this;return 1===arguments.length?(d=c,c=b,e=!1):(c=a.Key.encodeKey(c),e=!0),f.__idbObjectStore.transaction.__addToTransactionQueue(function(g,h,i,j){var k=["SELECT * FROM ",a.util.quote(f.__idbObjectStore.name)," WHERE",a.util.quote(f.indexName),"NOT NULL"],l=[];e&&(k.push("AND",a.util.quote(f.indexName)," = ?"),l.push(c)),a.DEBUG&&console.log("Trying to fetch data for Index",k.join(" "),l),g.executeSql(k.join(" "),l,function(c,e){var f;f="count"===d?e.rows.length:0===e.rows.length?b:"key"===d?a.Key.decode(e.rows.item(0).key):a.Sca.decode(e.rows.item(0).value),i(f)},j)})},c.prototype.get=function(a){if(0===arguments.length)throw new TypeError("No key was specified");return this.__fetchIndexData(a,"value")},c.prototype.getKey=function(a){if(0===arguments.length)throw new TypeError("No key was specified");return this.__fetchIndexData(a,"key")},c.prototype.count=function(a){return 0===arguments.length?this.__fetchIndexData("count"):this.__fetchIndexData(a,"count")},a.IDBIndex=c}(idbModules),function(a){function b(b,c,d){this.name=b,this.transaction=c,this.__ready={},this.__waiting={},this.__setReadyState("createObjectStore","undefined"==typeof d?!0:d),this.indexNames=new a.util.StringList;var e=c.db.__storeProperties;if(e[b]&&e[b].indexList){var f=e[b].indexList;for(var g in f)f.hasOwnProperty(g)&&this.indexNames.push(g)}}b.prototype.__setReadyState=function(a,b){this.__ready[a]=b,this.__runIfReady()},b.prototype.__isReady=function(a){if("ALL"===a){for(var b in this.__ready)if(!this.__ready[b])return!1;return!0}return"undefined"==typeof this.__ready[a]?!0:this.__ready[a]},b.prototype.__waitForReady=function(a,b){b=b||"ALL",this.__isReady(b)?a():(this.__waiting[b]=this.__waiting[b]||[],this.__waiting[b].push(a))},b.prototype.__runIfReady=function(){for(var b in this.__waiting)if(this.__isReady(b)){var c=this.__waiting[b];if(c&&c.length>0)for(a.DEBUG&&console.log(b+" is ready. Running callbacks.");c.length>0;){var d=c.shift();d()}}else a.DEBUG&&console.log("Waiting for "+b+" to be ready")},b.prototype.__getStoreProps=function(b,c,d){var e=this;this.__waitForReady(function(){e.__storeProps?(a.DEBUG&&console.log("Store properties - cached",e.__storeProps),c(e.__storeProps)):b.executeSql("SELECT * FROM __sys__ where name = ?",[e.name],function(b,d){if(1!==d.rows.length)c();else{var f=d.rows.item(0);e.__storeProps={name:f.name,indexList:f.indexList,autoInc:"number"==typeof f.autoInc?1===f.autoInc?"true":"false":f.autoInc,keyPath:f.keyPath},a.DEBUG&&console.log("Store properties",e.__storeProps),c(e.__storeProps)}},function(){c()})},d)},b.prototype.__deriveKey=function(b,c,d,e,f){function g(c){b.executeSql("SELECT * FROM sqlite_sequence where name like ?",[h.name],function(a,b){c(1!==b.rows.length?1:b.rows.item(0).seq+1)},function(b,c){f(a.util.createDOMException("Data Error","Could not get the auto increment value for key",c))})}var h=this;h.__getStoreProps(b,function(b){if(b||f(a.util.createDOMException("Data Error","Could not locate defination for this table",b)),b.keyPath)if("undefined"!=typeof d&&f(a.util.createDOMException("Data Error","The object store uses in-line keys and the key parameter was provided",b)),c){var h=a.Key.getKeyPath(c,b.keyPath);void 0===h?"true"===b.autoInc?g(function(d){try{a.Key.setKeyPath(c,b.keyPath,d),e(d)}catch(g){f(a.util.createDOMException("Data Error","Could not assign a generated value to the keyPath",g))}}):f(a.util.createDOMException("Data Error","Could not eval key from keyPath")):e(h)}else f(a.util.createDOMException("Data Error","KeyPath was specified, but value was not"));else"undefined"!=typeof d?e(d):"false"===b.autoInc?f(a.util.createDOMException("Data Error","The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",b)):g(e)})},b.prototype.__insertData=function(b,c,d,e,f,g){var h={};"undefined"!=typeof e&&(h.key=a.Key.encodeKey(e));var i=JSON.parse(this.__storeProps.indexList);for(var j in i)try{h[i[j].columnName]=a.Key.encode(a.Key.getKeyPath(d,i[j].keyPath))}catch(k){g(k)}var l=["INSERT INTO ",a.util.quote(this.name),"("],m=[" VALUES ("],n=[];for(j in h)l.push(a.util.quote(j)+","),m.push("?,"),n.push(h[j]);l.push("value )"),m.push("?)"),n.push(c);var o=l.join(" ")+m.join(" ");a.DEBUG&&console.log("SQL for adding",o,n),b.executeSql(o,n,function(){f(e)},function(b,c){g(a.util.createDOMError("ConstraintError",c.message,c))})},b.prototype.add=function(b,c){var d=this;if(0===arguments.length)throw new TypeError("No value was specified");d.transaction.__assertWritable();var e=d.transaction.__createRequest(function(){});return d.transaction.__pushToQueue(e,function(e,f,g,h){d.__deriveKey(e,b,c,function(c){a.Sca.encode(b,function(a){d.__insertData(e,a,b,c,g,h)})},h)}),e},b.prototype.put=function(b,c){var d=this;if(0===arguments.length)throw new TypeError("No value was specified");d.transaction.__assertWritable();var e=d.transaction.__createRequest(function(){});return d.transaction.__pushToQueue(e,function(e,f,g,h){d.__deriveKey(e,b,c,function(c){a.Sca.encode(b,function(f){var i="DELETE FROM "+a.util.quote(d.name)+" where key = ?";e.executeSql(i,[a.Key.encode(c)],function(e,i){a.DEBUG&&console.log("Did the row with the",c,"exist? ",i.rowsAffected),d.__insertData(e,f,b,c,g,h)},function(a,b){h(b)})})},h)}),e},b.prototype.get=function(b){var c=this;if(0===arguments.length)throw new TypeError("No key was specified");var d=a.Key.encodeKey(b);return c.transaction.__addToTransactionQueue(function(b,e,f,g){c.__waitForReady(function(){a.DEBUG&&console.log("Fetching",c.name,d),b.executeSql("SELECT * FROM "+a.util.quote(c.name)+" where key = ?",[d],function(b,c){a.DEBUG&&console.log("Fetched data",c);try{if(0===c.rows.length)return f();f(a.Sca.decode(c.rows.item(0).value))}catch(d){a.DEBUG&&console.log(d),f(void 0)}},function(a,b){g(b)})})})},b.prototype["delete"]=function(b){var c=this;if(0===arguments.length)throw new TypeError("No key was specified");c.transaction.__assertWritable();var d=a.Key.encodeKey(b);return c.transaction.__addToTransactionQueue(function(b,e,f,g){c.__waitForReady(function(){a.DEBUG&&console.log("Fetching",c.name,d),b.executeSql("DELETE FROM "+a.util.quote(c.name)+" where key = ?",[d],function(b,c){a.DEBUG&&console.log("Deleted from database",c.rowsAffected),f()},function(a,b){g(b)})})})},b.prototype.clear=function(){var b=this;return b.transaction.__assertWritable(),b.transaction.__addToTransactionQueue(function(c,d,e,f){b.__waitForReady(function(){c.executeSql("DELETE FROM "+a.util.quote(b.name),[],function(b,c){a.DEBUG&&console.log("Cleared all records from database",c.rowsAffected),e()},function(a,b){f(b)})})})},b.prototype.count=function(b){var c=this,d=!1;return arguments.length>0&&(d=!0,b=a.Key.encodeKey(b)),c.transaction.__addToTransactionQueue(function(e,f,g,h){c.__waitForReady(function(){var f="SELECT * FROM "+a.util.quote(c.name)+(d?" WHERE key = ?":""),i=[];d&&i.push(b),e.executeSql(f,i,function(a,b){g(b.rows.length)},function(a,b){h(b)})})})},b.prototype.openCursor=function(b,c){{var d=new a.IDBRequest;new a.IDBCursor(b,c,this,d,"key","value")}return d},b.prototype.index=function(b){if(0===arguments.length)throw new TypeError("No index name was specified");var c=new a.IDBIndex(b,this);return c},b.prototype.createIndex=function(b,c,d){var e=this;if(0===arguments.length)throw new TypeError("No index name was specified");if(1===arguments.length)throw new TypeError("No key path was specified");e.transaction.__assertVersionChange(),d=d||{},e.__setReadyState("createIndex",!1);var f=new a.IDBIndex(b,e);f.__createIndex(b,c,d),e.indexNames.push(b);var g=e.transaction.db.__storeProperties[e.name];return g.indexList[b]={keyPath:c,optionalParams:d},f},b.prototype.deleteIndex=function(b){if(0===arguments.length)throw new TypeError("No index name was specified");this.transaction.__assertVersionChange();var c=new a.IDBIndex(b,this,!1);return c.__deleteIndex(b),c},a.IDBObjectStore=b}(idbModules),function(a){function b(a,b,c){this.__active=!0,this.__running=!1,this.__requests=[],this.storeNames=a,this.mode=b,this.db=c,this.error=null,this.onabort=this.onerror=this.oncomplete=null;var d=this;setTimeout(function(){d.__executeRequests()},0)}b.prototype.__executeRequests=function(){function b(b){try{a.util.logError("Error","An error occurred in a transaction",b),d.error=b;var c=a.util.createEvent("error");a.util.callback("onerror",d,c)}finally{d.abort()}}function c(){a.DEBUG&&console.log("Transaction completed");var b=a.util.createEvent("complete");a.util.callback("oncomplete",d,b),a.util.callback("__oncomplete",d,b)}if(this.__running)return void(a.DEBUG&&console.log("Looks like the request set is already running",this.mode));this.__running=!0;var d=this;d.db.__db.transaction(function(e){function f(b,c){c&&(i.req=c),i.req.readyState="done",i.req.result=b,delete i.req.error;var d=a.util.createEvent("success");a.util.callback("onsuccess",i.req,d),j++,h()}function g(c,d){1===arguments.length&&(d=c);try{i.req.readyState="done",i.req.error=d||"DOMError";var e=a.util.createEvent("error",d);a.util.callback("onerror",i.req,e)}finally{b(d)}}function h(){if(j>=d.__requests.length)d.__requests=[],d.__active&&(d.__active=!1,c());else try{i=d.__requests[j];try{i.op(e,i.args,f,g)}catch(a){if(!(a instanceof DOMException&&11===a.code&&e===d.__tx))throw a;d.db.__db.transaction(function(a){i.op(a,i.args,f,g)})}}catch(a){g(a)}}d.__tx=e;var i=null,j=0;h()},b)},b.prototype.__addToTransactionQueue=function(a,b){var c=this.__createRequest();return this.__pushToQueue(c,a,b),c},b.prototype.__createRequest=function(){var b=new a.IDBRequest;return b.source=this.db,b.transaction=this,b},b.prototype.__pushToQueue=function(a,b,c){this.__assertActive(),this.__requests.push({op:b,args:c,req:a})},b.prototype.__assertActive=function(){if(!this.__active)throw a.util.createDOMException("TransactionInactiveError","A request was placed against a transaction which is currently not active, or which is finished")},b.prototype.__assertWritable=function(){if(this.mode===b.READ_ONLY)throw a.util.createDOMException("ReadOnlyError","The transaction is read only")},b.prototype.__assertVersionChange=function(){b.__assertVersionChange(this)},b.__assertVersionChange=function(c){if(!c||c.mode!==b.VERSION_CHANGE)throw a.util.createDOMException("InvalidStateError","Not a version transaction")},b.prototype.objectStore=function(b){return new a.IDBObjectStore(b,this)},b.prototype.abort=function(){var b=this;a.DEBUG&&console.log("The transaction was aborted",b),b.__active=!1;var c=a.util.createEvent("abort");setTimeout(function(){a.util.callback("onabort",b,c)},0)},b.READ_ONLY="readonly",b.READ_WRITE="readwrite",b.VERSION_CHANGE="versionchange",a.IDBTransaction=b}(idbModules),function(a){function b(b,c,d,e){this.__db=b,this.__closed=!1,this.version=d,this.objectStoreNames=new a.util.StringList;for(var f=0;f<e.rows.length;f++)this.objectStoreNames.push(e.rows.item(f).name);for(this.__storeProperties={},f=0;f<e.rows.length;f++){var g=e.rows.item(f),h=this.__storeProperties[g.name]={};h.keyPath=g.keypath,h.autoInc="true"===g.autoInc,h.indexList=JSON.parse(g.indexList)}this.name=c,this.onabort=this.onerror=this.onversionchange=null}b.prototype.createObjectStore=function(b,c){var d=this;c=c||{},c.keyPath=c.keyPath||null;var e=new a.IDBObjectStore(b,d.__versionTransaction,!1),f=d.__versionTransaction;a.IDBTransaction.__assertVersionChange(f),f.__addToTransactionQueue(function(d,f,g){function h(c,d){throw a.util.createDOMException(0,'Could not create object store "'+b+'"',d)}var i=["CREATE TABLE",a.util.quote(b),"(key BLOB",c.autoIncrement?"UNIQUE, inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");a.DEBUG&&console.log(i),d.executeSql(i,[],function(a){a.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[b,c.keyPath,!!c.autoIncrement,"{}"],function(){e.__setReadyState("createObjectStore",!0),g(e)},h)},h)}),d.objectStoreNames.push(b);var g=d.__storeProperties[b]={};return g.keyPath=c.keyPath,g.autoInc=!!c.autoIncrement,g.indexList={},e},b.prototype.deleteObjectStore=function(b){var c=function(b,c){throw a.util.createDOMException(0,"Could not delete ObjectStore",c)},d=this;!d.objectStoreNames.contains(b)&&c(null,"Object Store does not exist"),d.objectStoreNames.splice(d.objectStoreNames.indexOf(b),1);var e=d.__versionTransaction;a.IDBTransaction.__assertVersionChange(e),e.__addToTransactionQueue(function(e,f,g){d.__db.transaction(function(d){d.executeSql("SELECT * FROM __sys__ where name = ?",[b],function(d,e){e.rows.length>0&&d.executeSql("DROP TABLE "+a.util.quote(b),[],function(){d.executeSql("DELETE FROM __sys__ WHERE name = ?",[b],function(){g()},c)},c)})})})},b.prototype.close=function(){this.__closed=!0},b.prototype.transaction=function(b,c){if(this.__closed)throw a.util.createDOMException("InvalidStateError","An attempt was made to start a new transaction on a database connection that is not open");if("number"==typeof c?(c=1===c?IDBTransaction.READ_WRITE:IDBTransaction.READ_ONLY,a.DEBUG&&console.log("Mode should be a string, but was specified as ",c)):c=c||IDBTransaction.READ_ONLY,c!==IDBTransaction.READ_ONLY&&c!==IDBTransaction.READ_WRITE)throw new TypeError("Invalid transaction mode: "+c);if(b="string"==typeof b?[b]:b,0===b.length)throw a.util.createDOMException("InvalidAccessError","No object store names were specified");for(var d=0;d<b.length;d++)if(!this.objectStoreNames.contains(b[d]))throw a.util.createDOMException("NotFoundError",'The "'+b[d]+'" object store does not exist');var e=new a.IDBTransaction(b,c,this);return e},a.IDBDatabase=b}(idbModules),function(a){function b(){this.Event=a.Event,this.DOMException=a.DOMException,this.DOMError=a.DOMError}var c=4194304;if(window.openDatabase){var d=window.openDatabase("__sysdb__",1,"System Database",c);d.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[])},function(){a.DEBUG&&console.log("Error in sysdb transaction - when creating dbVersions",arguments)}),b.prototype.open=function(b,e){function f(b){if(!i){i=!0;var c=a.util.createEvent("error",arguments);h.readyState="done",h.error=b||"DOMError",a.util.callback("onerror",h,c)}}function g(g){var i=window.openDatabase(b,1,b,c);if(h.readyState="done","undefined"==typeof e&&(e=g||1),0>=e||g>e){var j=a.util.createDOMError("VersionError","An attempt was made to open a database using a lower version than the existing version.",e);return void f(j)}i.transaction(function(c){c.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){c.executeSql("SELECT * FROM __sys__",[],function(c,j){var k=a.util.createEvent("success");h.source=h.result=new a.IDBDatabase(i,b,e,j),e>g?d.transaction(function(c){c.executeSql("UPDATE dbVersions set version = ? where name = ?",[e,b],function(){var b=a.util.createEvent("upgradeneeded");b.oldVersion=g,b.newVersion=e,h.transaction=h.result.__versionTransaction=new a.IDBTransaction([],a.IDBTransaction.VERSION_CHANGE,h.source),h.transaction.__addToTransactionQueue(function(c,d,e){a.util.callback("onupgradeneeded",h,b),e()}),h.transaction.__oncomplete=function(){h.transaction=null;var b=a.util.createEvent("success");a.util.callback("onsuccess",h,b)}},f)},f):a.util.callback("onsuccess",h,k)},f)},f)},f)}var h=new a.IDBOpenDBRequest,i=!1;if(0===arguments.length)throw new TypeError("Database name is required");if(2===arguments.length&&(e=parseFloat(e),isNaN(e)||!isFinite(e)||0>=e))throw new TypeError("Invalid database version: "+e);return b+="",d.transaction(function(a){a.executeSql("SELECT * FROM dbVersions where name = ?",[b],function(a,c){0===c.rows.length?a.executeSql("INSERT INTO dbVersions VALUES (?,?)",[b,e||1],function(){g(0)},f):g(c.rows.item(0).version)},f)},f),h},b.prototype.deleteDatabase=function(b){function e(b){if(!h){g.readyState="done",g.error="DOMError";var c=a.util.createEvent("error");c.message=b,c.debug=arguments,a.util.callback("onerror",g,c),h=!0}}function f(){d.transaction(function(c){c.executeSql("DELETE FROM dbVersions where name = ? ",[b],function(){g.result=void 0;var b=a.util.createEvent("success");b.newVersion=null,b.oldVersion=i,a.util.callback("onsuccess",g,b)},e)},e)}var g=new a.IDBOpenDBRequest,h=!1,i=null;if(0===arguments.length)throw new TypeError("Database name is required");return b+="",d.transaction(function(d){d.executeSql("SELECT * FROM dbVersions where name = ?",[b],function(d,h){if(0===h.rows.length){g.result=void 0;var j=a.util.createEvent("success");return j.newVersion=null,j.oldVersion=i,void a.util.callback("onsuccess",g,j)}i=h.rows.item(0).version;var k=window.openDatabase(b,1,b,c);k.transaction(function(b){b.executeSql("SELECT * FROM __sys__",[],function(b,c){var d=c.rows;!function g(c){c>=d.length?b.executeSql("DROP TABLE __sys__",[],function(){f()},e):b.executeSql("DROP TABLE "+a.util.quote(d.item(c).name),[],function(){g(c+1)},function(){g(c+1)})}(0)},function(){f()})},e)})},e),g},b.prototype.cmp=function(b,c){return a.Key.encodeKey(b)>a.Key.encodeKey(c)?1:b===c?0:-1},a.shimIndexedDB=new b,a.IDBFactory=b}}(idbModules),function(a,b){function c(b,c){try{a[b]=c}catch(d){}if(a[b]!==c&&Object.defineProperty){try{Object.defineProperty(a,b,{value:c})}catch(d){}a[b]!==c&&a.console&&console.warn&&console.warn("Unable to shim "+b)}}"undefined"!=typeof a.openDatabase&&(c("shimIndexedDB",b.shimIndexedDB),a.shimIndexedDB&&(a.shimIndexedDB.__useShim=function(){c("indexedDB",b.shimIndexedDB),c("IDBFactory",b.IDBFactory),c("IDBDatabase",b.IDBDatabase),c("IDBObjectStore",b.IDBObjectStore),c("IDBIndex",b.IDBIndex),c("IDBTransaction",b.IDBTransaction),c("IDBCursor",b.IDBCursor),c("IDBKeyRange",b.IDBKeyRange),c("IDBRequest",b.IDBRequest),c("IDBOpenDBRequest",b.IDBOpenDBRequest),c("IDBVersionChangeEvent",b.IDBVersionChangeEvent)},a.shimIndexedDB.__debug=function(a){b.DEBUG=a})),"indexedDB"in a||(a.indexedDB=a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.oIndexedDB||a.msIndexedDB);var d=!1;if((navigator.userAgent.match(/Android 2/)||navigator.userAgent.match(/Android 3/)||navigator.userAgent.match(/Android 4\.[0-3]/))&&(navigator.userAgent.match(/Chrome/)||(d=!0)),"undefined"!=typeof a.indexedDB&&a.indexedDB&&!d||"undefined"==typeof a.openDatabase){
a.IDBDatabase=a.IDBDatabase||a.webkitIDBDatabase,a.IDBTransaction=a.IDBTransaction||a.webkitIDBTransaction,a.IDBCursor=a.IDBCursor||a.webkitIDBCursor,a.IDBKeyRange=a.IDBKeyRange||a.webkitIDBKeyRange,a.IDBTransaction||(a.IDBTransaction={});try{a.IDBTransaction.READ_ONLY=a.IDBTransaction.READ_ONLY||"readonly",a.IDBTransaction.READ_WRITE=a.IDBTransaction.READ_WRITE||"readwrite"}catch(e){}}else a.shimIndexedDB.__useShim()}(window,idbModules);
//# sourceMappingURL=indexeddbshim.min.js.map