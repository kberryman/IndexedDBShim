/*! indexeddbshim - v0.1.2 - 2015-04-03 */

"use strict";var idbModules={util:{}},cleanInterface=!1;!function(){var a={test:!0};if(Object.defineProperty)try{Object.defineProperty(a,"test",{enumerable:!1}),a.test&&(cleanInterface=!0)}catch(b){}}(),function(a){function b(a,b,c){c.target=b,"function"==typeof b[a]&&b[a].apply(b,[c])}var c=function(){this.length=0,this._items=[],cleanInterface&&Object.defineProperty(this,"_items",{enumerable:!1})};if(c.prototype={contains:function(a){return-1!==this._items.indexOf(a)},item:function(a){return this._items[a]},indexOf:function(a){return this._items.indexOf(a)},push:function(a){this._items.push(a),this.length+=1;for(var b=0;b<this._items.length;b++)this[b]=this._items[b]},splice:function(){this._items.splice.apply(this._items,arguments),this.length=this._items.length;for(var a in this)a===String(parseInt(a,10))&&delete this[a];for(a=0;a<this._items.length;a++)this[a]=this._items[a]}},cleanInterface)for(var d in{indexOf:!1,push:!1,splice:!1})Object.defineProperty(c.prototype,d,{enumerable:!1});a.util.callback=b,a.util.StringList=c,a.util.quote=function(a){return'"'+a+'"'}}(idbModules),function(idbModules){var Sca=function(){return{decycle:function(object,callback){function checkForCompletion(){0===queuedObjects.length&&returnCallback(derezObj)}function readBlobAsDataURL(a,b){var c=new FileReader;c.onloadend=function(c){var d=c.target.result,e="blob";a instanceof File,updateEncodedBlob(d,b,e)},c.readAsDataURL(a)}function updateEncodedBlob(dataURL,path,blobtype){var encoded=queuedObjects.indexOf(path);path=path.replace("$","derezObj"),eval(path+'.$enc="'+dataURL+'"'),eval(path+'.$type="'+blobtype+'"'),queuedObjects.splice(encoded,1),checkForCompletion()}function derez(a,b){var c,d,e;if(!("object"!=typeof a||null===a||a instanceof Boolean||a instanceof Date||a instanceof Number||a instanceof RegExp||a instanceof Blob||a instanceof String)){for(c=0;c<objects.length;c+=1)if(objects[c]===a)return{$ref:paths[c]};if(objects.push(a),paths.push(b),"[object Array]"===Object.prototype.toString.apply(a))for(e=[],c=0;c<a.length;c+=1)e[c]=derez(a[c],b+"["+c+"]");else{e={};for(d in a)Object.prototype.hasOwnProperty.call(a,d)&&(e[d]=derez(a[d],b+"["+JSON.stringify(d)+"]"))}return e}return a instanceof Blob?(queuedObjects.push(b),readBlobAsDataURL(a,b)):a instanceof Boolean?a={$type:"bool",$enc:a.toString()}:a instanceof Date?a={$type:"date",$enc:a.getTime()}:a instanceof Number?a={$type:"num",$enc:a.toString()}:a instanceof RegExp&&(a={$type:"regex",$enc:a.toString()}),a}var objects=[],paths=[],queuedObjects=[],returnCallback=callback,derezObj=derez(object,"$");checkForCompletion()},retrocycle:function retrocycle($){function dataURLToBlob(a){var b,c,d,e=";base64,";if(-1===a.indexOf(e))return c=a.split(","),b=c[0].split(":")[1],d=c[1],new Blob([d],{type:b});c=a.split(e),b=c[0].split(":")[1],d=window.atob(c[1]);for(var f=d.length,g=new Uint8Array(f),h=0;f>h;++h)g[h]=d.charCodeAt(h);return new Blob([g.buffer],{type:b})}function rez(value){var i,item,name,path;if(value&&"object"==typeof value)if("[object Array]"===Object.prototype.toString.apply(value))for(i=0;i<value.length;i+=1)item=value[i],item&&"object"==typeof item&&(path=item.$ref,value[i]="string"==typeof path&&px.test(path)?eval(path):rez(item));else if(void 0!==value.$type)switch(value.$type){case"blob":case"file":value=dataURLToBlob(value.$enc);break;case"bool":value=Boolean("true"===value.$enc);break;case"date":value=new Date(value.$enc);break;case"num":value=Number(value.$enc);break;case"regex":value=eval(value.$enc)}else for(name in value)"object"==typeof value[name]&&(item=value[name],item&&(path=item.$ref,value[name]="string"==typeof path&&px.test(path)?eval(path):rez(item)));return value}var px=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return rez($),$},encode:function(a,b){function c(a){b(JSON.stringify(a))}this.decycle(a,c)},decode:function(a){return this.retrocycle(JSON.parse(a))}}}();idbModules.Sca=Sca}(idbModules),function(a){var b=["","number","string","boolean","object","undefined"],c=function(){return{encode:function(a){return b.indexOf(typeof a)+"-"+JSON.stringify(a)},decode:function(a){return"undefined"==typeof a?void 0:JSON.parse(a.substring(2))}}},d={number:c("number"),"boolean":c(),object:c(),string:{encode:function(a){return b.indexOf("string")+"-"+a},decode:function(a){return""+a.substring(2)}},undefined:{encode:function(){return b.indexOf("undefined")+"-undefined"},decode:function(){return void 0}}},e=function(){return{encode:function(a){return d[typeof a].encode(a)},decode:function(a){return d[b[a.substring(0,1)]].decode(a)}}}();a.Key=e}(idbModules),function(a){function b(a,b){var c=new Event(a);return c.debug=b,Object.defineProperty(c,"target",{writable:!0}),c}function c(a,b){this.type=a,this.debug=b,this.bubbles=!1,this.cancelable=!1,this.eventPhase=0,this.timeStamp=(new Date).valueOf()}var d=!1;try{var e=b("test type","test debug"),f={test:"test target"};e.target=f,e instanceof Event&&"test type"===e.type&&"test debug"===e.debug&&e.target===f&&(d=!0)}catch(g){}d?(a.Event=Event,a.IDBVersionChangeEvent=Event,a.util.createEvent=b):(a.Event=c,a.IDBVersionChangeEvent=c,a.util.createEvent=function(a,b){return new c(a,b)})}(idbModules),function(a){function b(a,b){var c=new DOMException.prototype.constructor(0,b);return c.name=a||"DOMException",c.message=b,c}function c(a,b){a=a||"DOMError";var c=new DOMError(a,b);return c.name===a||(c.name=a),c.message===b||(c.message=b),c}function d(a,b){var c=new Error(b);return c.name=a||"DOMException",c.message=b,c}function e(b,c,d){if(a.DEBUG){d&&d.message&&(d=d.message);var e="function"==typeof console.error?"error":"log";console[e](b+": "+c+". "+(d||"")),console.trace&&console.trace()}}var f,g=!1,h=!1;try{f=b("test name","test message"),f instanceof DOMException&&"test name"===f.name&&"test message"===f.message&&(g=!0)}catch(i){}try{f=c("test name","test message"),f instanceof DOMError&&"test name"===f.name&&"test message"===f.message&&(h=!0)}catch(i){}a.util.logError=e,g?(a.DOMException=DOMException,a.util.createDOMException=function(a,c,d){return e(a,c,d),b(a,c)}):(a.DOMException=Error,a.util.createDOMException=function(a,b,c){return e(a,b,c),d(a,b)}),h?(a.DOMError=DOMError,a.util.createDOMError=function(a,b,d){return e(a,b,d),c(a,b)}):(a.DOMError=Error,a.util.createDOMError=function(a,b,c){return e(a,b,c),d(a,b)})}(idbModules),function(a){function b(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null,this.readyState="pending"}function c(){this.onblocked=this.onupgradeneeded=null}c.prototype=new b,c.prototype.constructor=c,a.IDBRequest=b,a.IDBOpenDBRequest=c}(idbModules),function(a,b){function c(a,b,c,d){this.lower=a,this.upper=b,this.lowerOpen=c,this.upperOpen=d}c.only=function(a){return new c(a,a,!1,!1)},c.lowerBound=function(a,d){return new c(a,b,d,b)},c.upperBound=function(a,d){return new c(b,a,b,d)},c.bound=function(a,b,d,e){return new c(a,b,d,e)},a.IDBKeyRange=c}(idbModules),function(a,b){function c(c,d,e,f,g,h){if(!c||c instanceof a.IDBKeyRange||(c=new a.IDBKeyRange(c,c,!1,!1)),this.__range=c,this.source=this.__idbObjectStore=e,this.__req=f,this.key=b,this.direction=d,this.__keyColumnName=g,this.__valueColumnName=h,this.__valueDecoder="value"===h?a.Sca:a.Key,!this.source.transaction.__active)throw a.util.createDOMException("TransactionInactiveError","The transaction this IDBObjectStore belongs to is not active.");this.__offset=-1,this.__lastKeyContinued=b,this["continue"]()}c.prototype.__find=function(c,d,e,f,g){g=g||1;var h=this,i=["SELECT * FROM ",a.util.quote(h.__idbObjectStore.name)],j=[];i.push("WHERE ",h.__keyColumnName," NOT NULL"),!h.__range||h.__range.lower===b&&h.__range.upper===b||(i.push("AND"),h.__range.lower!==b&&(i.push(h.__keyColumnName+(h.__range.lowerOpen?" >":" >= ")+" ?"),j.push(a.Key.encode(h.__range.lower))),h.__range.lower!==b&&h.__range.upper!==b&&i.push("AND"),h.__range.upper!==b&&(i.push(h.__keyColumnName+(h.__range.upperOpen?" < ":" <= ")+" ?"),j.push(a.Key.encode(h.__range.upper)))),"undefined"!=typeof c&&(h.__lastKeyContinued=c,h.__offset=0),h.__lastKeyContinued!==b&&(i.push("AND "+h.__keyColumnName+" >= ?"),j.push(a.Key.encode(h.__lastKeyContinued)));var k="prev"===h.direction||"prevunique"===h.direction?"DESC":"ASC";i.push("ORDER BY ",h.__keyColumnName," "+k),i.push("LIMIT "+g+" OFFSET "+h.__offset),a.DEBUG&&console.log(i.join(" "),j),h.__prefetchedData=null,d.executeSql(i.join(" "),j,function(c,d){d.rows.length>1?(h.__prefetchedData=d.rows,h.__prefetchedIndex=0,a.DEBUG&&console.log("Preloaded "+h.__prefetchedData.length+" records for cursor"),h.__decode(d.rows.item(0),e)):1===d.rows.length?h.__decode(d.rows.item(0),e):(a.DEBUG&&console.log("Reached end of cursors"),e(b,b))},function(b,c){a.DEBUG&&console.log("Could not execute Cursor.continue"),f(c)})},c.prototype.__decode=function(b,c){var d=a.Key.decode(b[this.__keyColumnName]),e=this.__valueDecoder.decode(b[this.__valueColumnName]),f=a.Key.decode(b.key);c(d,e,f)},c.prototype["continue"]=function(c){var d=a.cursorPreloadPackSize||100,e=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(a,f,g,h){e.__offset++;var i=function(a,c,d){e.key=a,e.value=c,e.primaryKey=d,g("undefined"!=typeof e.key?e:b,e.__req)};return e.__prefetchedData&&(e.__prefetchedIndex++,e.__prefetchedIndex<e.__prefetchedData.length)?void e.__decode(e.__prefetchedData.item(e.__prefetchedIndex),i):void e.__find(c,a,i,h,d)})},c.prototype.advance=function(c){if(0>=c)throw a.util.createDOMException("Type Error","Count is invalid - 0 or negative",c);var d=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(a,e,f,g){d.__offset+=c,d.__find(b,a,function(a,c){d.key=a,d.value=c,f("undefined"!=typeof d.key?d:b,d.__req)},g)})},c.prototype.update=function(c){var d=this;d.__idbObjectStore.transaction.__assertWritable();var e=this.__idbObjectStore.transaction.__createRequest(function(){});return a.Sca.encode(c,function(f){d.__idbObjectStore.transaction.__pushToQueue(e,function(e,g,h,i){d.__find(b,e,function(b,g,j){var k=d.__idbObjectStore,l=d.__idbObjectStore.transaction.db.__storeProperties,m=[f],n="UPDATE "+a.util.quote(k.name)+" SET value = ?",o=l[k.name]&&l[k.name].indexList;if(o)for(var p in o){var q=o[p];n+=", "+p+" = ?",m.push(a.Key.encode(c[q.keyPath]))}n+=" WHERE key = ?",m.push(a.Key.encode(j)),a.DEBUG&&console.log(n,f,b,j),e.executeSql(n,m,function(a,c){d.__prefetchedData=null,1===c.rowsAffected?h(b):i("No rows with key found"+b)},function(a,b){i(b)})},i)})}),e},c.prototype["delete"]=function(){var c=this;return c.__idbObjectStore.transaction.__assertWritable(),this.__idbObjectStore.transaction.__addToTransactionQueue(function(d,e,f,g){c.__find(b,d,function(e,h,i){var j="DELETE FROM  "+a.util.quote(c.__idbObjectStore.name)+" WHERE key = ?";a.DEBUG&&console.log(j,e,i),d.executeSql(j,[a.Key.encode(i)],function(a,d){c.__prefetchedData=null,1===d.rowsAffected?(c.__offset--,f(b)):g("No rows with key found"+e)},function(a,b){g(b)})},g)})},a.IDBCursor=c}(idbModules),function(idbModules,undefined){function IDBIndex(a,b){this.indexName=this.name=a,this.__idbObjectStore=this.objectStore=this.source=b;var c=b.transaction.db.__storeProperties[b.name],d=c&&c.indexList;this.keyPath=d&&d[a]&&d[a].keyPath||a,["multiEntry","unique"].forEach(function(b){this[b]=!!(d&&d[a]&&d[a].optionalParams&&d[a].optionalParams[b])},this)}IDBIndex.prototype.__createIndex=function(indexName,keyPath,optionalParameters){var me=this,transaction=me.__idbObjectStore.transaction;transaction.__addToTransactionQueue(function createIndex(tx,args,success,failure){me.__idbObjectStore.__getStoreProps(tx,function(){function error(a,b){transaction.__error(idbModules.util.createDOMException(0,'Could not create index "'+indexName+'"',b))}var idxList=JSON.parse(me.__idbObjectStore.__storeProps.indexList);"undefined"!=typeof idxList[indexName]&&transaction.__error(idbModules.util.createDOMException(0,'Index "'+indexName+'" already exists on store "'+me.__idbObjectStore.name+'"',idxList));var columnName=indexName;idxList[indexName]={columnName:columnName,keyPath:keyPath,optionalParams:optionalParameters},me.__idbObjectStore.__storeProps.indexList=JSON.stringify(idxList);var sql=["ALTER TABLE",idbModules.util.quote(me.__idbObjectStore.name),"ADD",idbModules.util.quote(columnName),"BLOB"].join(" ");idbModules.DEBUG&&console.log(sql),tx.executeSql(sql,[],function(tx,data){tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.__idbObjectStore.name),[],function(tx,data){!function initIndexForRow(i){if(i<data.rows.length)try{var value=idbModules.Sca.decode(data.rows.item(i).value),indexKey=eval("value['"+keyPath+"']");tx.executeSql("UPDATE "+idbModules.util.quote(me.__idbObjectStore.name)+" set "+idbModules.util.quote(columnName)+" = ? where key = ?",[idbModules.Key.encode(indexKey),data.rows.item(i).key],function(){initIndexForRow(i+1)},error)}catch(e){initIndexForRow(i+1)}else idbModules.DEBUG&&console.log("Updating the indexes in table",me.__idbObjectStore.__storeProps),tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[me.__idbObjectStore.__storeProps.indexList,me.__idbObjectStore.name],function(){me.__idbObjectStore.__setReadyState("createIndex",!0),success(me)},error)}(0)},error)},error)},"createObjectStore")})},IDBIndex.prototype.openCursor=function(a,b){{var c=new idbModules.IDBRequest;new idbModules.IDBCursor(a,b,this.source,c,this.indexName,"value")}return c},IDBIndex.prototype.openKeyCursor=function(a,b){{var c=new idbModules.IDBRequest;new idbModules.IDBCursor(a,b,this.source,c,this.indexName,"key")}return c},IDBIndex.prototype.__fetchIndexData=function(a,b){var c=this;return c.__idbObjectStore.transaction.__addToTransactionQueue(function(d,e,f,g){var h=["SELECT * FROM ",idbModules.util.quote(c.__idbObjectStore.name)," WHERE",idbModules.util.quote(c.indexName),"NOT NULL"],i=[];"undefined"!=typeof a&&(h.push("AND",idbModules.util.quote(c.indexName)," = ?"),i.push(idbModules.Key.encode(a))),idbModules.DEBUG&&console.log("Trying to fetch data for Index",h.join(" "),i),d.executeSql(h.join(" "),i,function(a,c){var d;d="count"===b?c.rows.length:0===c.rows.length?undefined:"key"===b?idbModules.Key.decode(c.rows.item(0).key):idbModules.Sca.decode(c.rows.item(0).value),f(d)},g)})},IDBIndex.prototype.get=function(a){return this.__fetchIndexData(a,"value")},IDBIndex.prototype.getKey=function(a){return this.__fetchIndexData(a,"key")},IDBIndex.prototype.count=function(a){return this.__fetchIndexData(a,"count")},idbModules.IDBIndex=IDBIndex}(idbModules),function(idbModules){function IDBObjectStore(a,b,c){this.name=a,this.transaction=b,this.__ready={},this.__waiting={},this.__setReadyState("createObjectStore","undefined"==typeof c?!0:c),this.indexNames=new idbModules.util.StringList;var d=b.db.__storeProperties;if(d[a]&&d[a].indexList){var e=d[a].indexList;for(var f in e)e.hasOwnProperty(f)&&this.indexNames.push(f)}}IDBObjectStore.prototype.__setReadyState=function(a,b){this.__ready[a]=b,this.__runIfReady()},IDBObjectStore.prototype.__isReady=function(a){if("ALL"===a){for(var b in this.__ready)if(!this.__ready[b])return!1;return!0}return"undefined"==typeof this.__ready[a]?!0:this.__ready[a]},IDBObjectStore.prototype.__waitForReady=function(a,b){b=b||"ALL",this.__isReady(b)?a():(this.__waiting[b]=this.__waiting[b]||[],this.__waiting[b].push(a))},IDBObjectStore.prototype.__runIfReady=function(){for(var a in this.__waiting)if(this.__isReady(a)){var b=this.__waiting[a];if(b&&b.length>0)for(idbModules.DEBUG&&console.log(a+" is ready. Running callbacks.");b.length>0;){var c=b.shift();c()}}else idbModules.DEBUG&&console.log("Waiting for "+a+" to be ready")},IDBObjectStore.prototype.__getStoreProps=function(a,b,c){var d=this;this.__waitForReady(function(){d.__storeProps?(idbModules.DEBUG&&console.log("Store properties - cached",d.__storeProps),b(d.__storeProps)):a.executeSql("SELECT * FROM __sys__ where name = ?",[d.name],function(a,c){if(1!==c.rows.length)b();else{var e=c.rows.item(0);d.__storeProps={name:e.name,indexList:e.indexList,autoInc:"number"==typeof e.autoInc?1===e.autoInc?"true":"false":e.autoInc,keyPath:e.keyPath},idbModules.DEBUG&&console.log("Store properties",d.__storeProps),b(d.__storeProps)}},function(){b()})},c)},IDBObjectStore.prototype.__deriveKey=function(tx,value,key,callback){function getNextAutoIncKey(){tx.executeSql("SELECT * FROM sqlite_sequence where name like ?",[me.name],function(a,b){callback(1!==b.rows.length?1:b.rows.item(0).seq)},function(a,b){me.transaction.__error(idbModules.util.createDOMException("Data Error","Could not get the auto increment value for key",b))})}var me=this;me.__getStoreProps(tx,function(props){if(props||me.transaction.__error(idbModules.util.createDOMException("Data Error","Could not locate defination for this table",props)),props.keyPath)if("undefined"!=typeof key&&me.transaction.__error(idbModules.util.createDOMException("Data Error","The object store uses in-line keys and the key parameter was provided",props)),value)try{var primaryKey=eval("value['"+props.keyPath+"']");void 0===primaryKey?"true"===props.autoInc?getNextAutoIncKey():me.transaction.__error(idbModules.util.createDOMException("Data Error","Could not eval key from keyPath")):callback(primaryKey)}catch(e){me.transaction.__error(idbModules.util.createDOMException("Data Error","Could not eval key from keyPath",e))}else me.transaction.__error(idbModules.util.createDOMException("Data Error","KeyPath was specified, but value was not"));else"undefined"!=typeof key?callback(key):"false"===props.autoInc?me.transaction.__error(idbModules.util.createDOMException("Data Error","The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",props)):getNextAutoIncKey()})},IDBObjectStore.prototype.__insertData=function(tx,encoded,value,primaryKey,success,error){var paramMap={};"undefined"!=typeof primaryKey&&(paramMap.key=idbModules.Key.encode(primaryKey));var indexes=JSON.parse(this.__storeProps.indexList);for(var key in indexes)try{paramMap[indexes[key].columnName]=idbModules.Key.encode(eval("value['"+indexes[key].keyPath+"']"))}catch(e){error(e)}var sqlStart=["INSERT INTO ",idbModules.util.quote(this.name),"("],sqlEnd=[" VALUES ("],sqlValues=[];for(key in paramMap)sqlStart.push(idbModules.util.quote(key)+","),sqlEnd.push("?,"),sqlValues.push(paramMap[key]);sqlStart.push("value )"),sqlEnd.push("?)"),sqlValues.push(encoded);var sql=sqlStart.join(" ")+sqlEnd.join(" ");idbModules.DEBUG&&console.log("SQL for adding",sql,sqlValues),tx.executeSql(sql,sqlValues,function(){success(primaryKey)},function(a,b){error(b)})},IDBObjectStore.prototype.add=function(a,b){var c=this;c.transaction.__assertWritable();var d=c.transaction.__createRequest(function(){});return idbModules.Sca.encode(a,function(e){c.transaction.__pushToQueue(d,function(d,f,g,h){c.__deriveKey(d,a,b,function(b){c.__insertData(d,e,a,b,g,h)})})}),d},IDBObjectStore.prototype.put=function(a,b){var c=this;c.transaction.__assertWritable();var d=c.transaction.__createRequest(function(){});return idbModules.Sca.encode(a,function(e){c.transaction.__pushToQueue(d,function(d,f,g,h){c.__deriveKey(d,a,b,function(b){var f="DELETE FROM "+idbModules.util.quote(c.name)+" where key = ?";d.executeSql(f,[idbModules.Key.encode(b)],function(d,f){idbModules.DEBUG&&console.log("Did the row with the",b,"exist? ",f.rowsAffected),c.__insertData(d,e,a,b,g,h)},function(a,b){h(b)})})})}),d},IDBObjectStore.prototype.get=function(a){var b=this;return b.transaction.__addToTransactionQueue(function(c,d,e,f){b.__waitForReady(function(){var d=idbModules.Key.encode(a);idbModules.DEBUG&&console.log("Fetching",b.name,d),c.executeSql("SELECT * FROM "+idbModules.util.quote(b.name)+" where key = ?",[d],function(a,b){idbModules.DEBUG&&console.log("Fetched data",b);try{if(0===b.rows.length)return e();e(idbModules.Sca.decode(b.rows.item(0).value))}catch(c){idbModules.DEBUG&&console.log(c),e(void 0)}},function(a,b){f(b)})})})},IDBObjectStore.prototype["delete"]=function(a){var b=this;return b.transaction.__assertWritable(),b.transaction.__addToTransactionQueue(function(c,d,e,f){b.__waitForReady(function(){var d=idbModules.Key.encode(a);idbModules.DEBUG&&console.log("Fetching",b.name,d),c.executeSql("DELETE FROM "+idbModules.util.quote(b.name)+" where key = ?",[d],function(a,b){idbModules.DEBUG&&console.log("Deleted from database",b.rowsAffected),e()},function(a,b){f(b)})})})},IDBObjectStore.prototype.clear=function(){var a=this;return a.transaction.__assertWritable(),a.transaction.__addToTransactionQueue(function(b,c,d,e){a.__waitForReady(function(){b.executeSql("DELETE FROM "+idbModules.util.quote(a.name),[],function(a,b){idbModules.DEBUG&&console.log("Cleared all records from database",b.rowsAffected),d()},function(a,b){e(b)})})})},IDBObjectStore.prototype.count=function(a){var b=this;return b.transaction.__addToTransactionQueue(function(c,d,e,f){b.__waitForReady(function(){var d="SELECT * FROM "+idbModules.util.quote(b.name)+("undefined"!=typeof a?" WHERE key = ?":""),g=[];"undefined"!=typeof a&&g.push(idbModules.Key.encode(a)),c.executeSql(d,g,function(a,b){e(b.rows.length)},function(a,b){f(b)})})})},IDBObjectStore.prototype.openCursor=function(a,b){{var c=new idbModules.IDBRequest;new idbModules.IDBCursor(a,b,this,c,"key","value")}return c},IDBObjectStore.prototype.index=function(a){var b=new idbModules.IDBIndex(a,this);return b},IDBObjectStore.prototype.createIndex=function(a,b,c){var d=this;d.transaction.__assertVersionChange(),c=c||{},d.__setReadyState("createIndex",!1);var e=new idbModules.IDBIndex(a,d);e.__createIndex(a,b,c),d.indexNames.push(a);var f=d.transaction.db.__storeProperties[d.name];return f.indexList[a]={keyPath:b,optionalParams:c},e},IDBObjectStore.prototype.deleteIndex=function(a){this.transaction.__assertVersionChange();var b=new idbModules.IDBIndex(a,this,!1);return b.__deleteIndex(a),b},idbModules.IDBObjectStore=IDBObjectStore}(idbModules),function(a){function b(a,b,c){this.__active=!0,this.__running=!1,this.__requests=[],this.storeNames=a,this.mode=b,this.db=c,this.error=null,this.onabort=this.onerror=this.oncomplete=null;var d=this;setTimeout(function(){d.__executeRequests()},0)}b.prototype.__executeRequests=function(){function b(){a.DEBUG&&console.log("Transaction completed");var b=a.util.createEvent("complete");a.util.callback("oncomplete",c,b),a.util.callback("__oncomplete",c,b)}if(this.__running)return void(a.DEBUG&&console.log("Looks like the request set is already running",this.mode));this.__running=!0;var c=this;c.db.__db.transaction(function(d){function e(b,c){c&&(h.req=c),h.req.readyState="done",h.req.result=b,delete h.req.error;var d=a.util.createEvent("success");a.util.callback("onsuccess",h.req,d),i++,g()}function f(b,d){1===arguments.length&&(d=b),h.req.readyState="done",h.req.error=d||"DOMError";var e=a.util.createEvent("error",d);a.util.callback("onerror",h.req,e),c.__error(d)}function g(){try{i>=c.__requests.length?(c.__active=!1,c.__requests=[],setTimeout(b,0)):(h=c.__requests[i],h.op(d,h.args,e,f))}catch(a){c.__error(a)}}c.__tx=d;var h=null,i=0;g()},function(a){c.__error(a)})},b.prototype.__addToTransactionQueue=function(a,b){var c=this.__createRequest();return this.__pushToQueue(c,a,b),c},b.prototype.__createRequest=function(){var b=new a.IDBRequest;return b.source=this.db,b.transaction=this,b},b.prototype.__pushToQueue=function(a,b,c){this.__assertActive(),this.__requests.push({op:b,args:c,req:a})},b.prototype.__assertActive=function(){if(!this.__active)throw a.util.createDOMException("TransactionInactiveError","A request was placed against a transaction which is currently not active, or which is finished")},b.prototype.__assertWritable=function(){if(this.mode===b.READ_ONLY)throw a.util.createDOMException("ReadOnlyError","The transaction is read only")},b.prototype.__assertVersionChange=function(){b.__assertVersionChange(this)},b.__assertVersionChange=function(c){if(!c||c.mode!==b.VERSION_CHANGE)throw a.util.createDOMException("InvalidStateError","Not a version transaction")},b.prototype.__error=function(b){a.util.logError("Error","An error occurred in a transaction",b),this.error=b,this.abort();var c=a.util.createEvent("error");a.util.callback("onerror",this,c)},b.prototype.objectStore=function(b){return new a.IDBObjectStore(b,this)},b.prototype.abort=function(){this.__active=!1},b.READ_ONLY="readonly",b.READ_WRITE="readwrite",b.VERSION_CHANGE="versionchange",a.IDBTransaction=b}(idbModules),function(a){function b(b,c,d,e){this.__db=b,this.__closed=!1,this.version=d,this.objectStoreNames=new a.util.StringList;for(var f=0;f<e.rows.length;f++)this.objectStoreNames.push(e.rows.item(f).name);for(this.__storeProperties={},f=0;f<e.rows.length;f++){var g=e.rows.item(f),h=this.__storeProperties[g.name]={};h.keyPath=g.keypath,h.autoInc="true"===g.autoInc,h.indexList=JSON.parse(g.indexList)}this.name=c,this.onabort=this.onerror=this.onversionchange=null}b.prototype.createObjectStore=function(b,c){var d=this;c=c||{},c.keyPath=c.keyPath||null;var e=new a.IDBObjectStore(b,d.__versionTransaction,!1),f=d.__versionTransaction;a.IDBTransaction.__assertVersionChange(f),f.__addToTransactionQueue(function(d,f,g){function h(c,d){throw a.util.createDOMException(0,'Could not create object store "'+b+'"',d)}var i=["CREATE TABLE",a.util.quote(b),"(key BLOB",c.autoIncrement?", inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");a.DEBUG&&console.log(i),d.executeSql(i,[],function(a){a.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[b,c.keyPath,c.autoIncrement?!0:!1,"{}"],function(){e.__setReadyState("createObjectStore",!0),g(e)},h)},h)}),d.objectStoreNames.push(b);var g=d.__storeProperties[b]={};return g.keyPath=c.keyPath,g.autoInc=!!c.autoIncrement,g.indexList={},e},b.prototype.deleteObjectStore=function(b){var c=function(b,c){throw a.util.createDOMException(0,"Could not delete ObjectStore",c)},d=this;!d.objectStoreNames.contains(b)&&c(null,"Object Store does not exist"),d.objectStoreNames.splice(d.objectStoreNames.indexOf(b),1);var e=d.__versionTransaction;a.IDBTransaction.__assertVersionChange(e),e.__addToTransactionQueue(function(e,f,g){d.__db.transaction(function(d){d.executeSql("SELECT * FROM __sys__ where name = ?",[b],function(d,e){e.rows.length>0&&d.executeSql("DROP TABLE "+a.util.quote(b),[],function(){d.executeSql("DELETE FROM __sys__ WHERE name = ?",[b],function(){g()},c)},c)})})})},b.prototype.close=function(){this.__closed=!0},b.prototype.transaction=function(b,c){if(this.__closed)throw a.util.createDOMException("InvalidStateError","An attempt was made to start a new transaction on a database connection that is not open");if("number"==typeof c?(c=1===c?IDBTransaction.READ_WRITE:IDBTransaction.READ_ONLY,a.DEBUG&&console.log("Mode should be a string, but was specified as ",c)):c=c||IDBTransaction.READ_ONLY,c!==IDBTransaction.READ_ONLY&&c!==IDBTransaction.READ_WRITE)throw new TypeError("Invalid transaction mode: "+c);if(b="string"==typeof b?[b]:b,0===b.length)throw a.util.createDOMException("InvalidAccessError","No object store names were specified");for(var d=0;d<b.length;d++)if(!this.objectStoreNames.contains(b[d]))throw a.util.createDOMException("NotFoundError",'The "'+b[d]+'" object store does not exist');var e=new a.IDBTransaction(b,c,this);return e},a.IDBDatabase=b}(idbModules),function(a){function b(){this.Event=a.Event,this.DOMException=a.DOMException,this.DOMError=a.DOMError}var c=4194304;if(window.openDatabase){var d=window.openDatabase("__sysdb__",1,"System Database",c);d.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[])},function(){a.DEBUG&&console.log("Error in sysdb transaction - when creating dbVersions",arguments)}),b.prototype.open=function(b,e){function f(b){if(!i){i=!0;var c=a.util.createEvent("error",arguments);h.readyState="done",h.error=b||"DOMError",a.util.callback("onerror",h,c)}}function g(g){var i=window.openDatabase(b,1,b,c);if(h.readyState="done","undefined"==typeof e&&(e=g||1),0>=e||g>e){var j=a.util.createDOMError("VersionError","An attempt was made to open a database using a lower version than the existing version.",e);return void f(j)}i.transaction(function(c){c.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){c.executeSql("SELECT * FROM __sys__",[],function(c,j){var k=a.util.createEvent("success");h.source=h.result=new a.IDBDatabase(i,b,e,j),e>g?d.transaction(function(c){c.executeSql("UPDATE dbVersions set version = ? where name = ?",[e,b],function(){var b=a.util.createEvent("upgradeneeded");b.oldVersion=g,b.newVersion=e,h.transaction=h.result.__versionTransaction=new a.IDBTransaction([],a.IDBTransaction.VERSION_CHANGE,h.source),h.transaction.__addToTransactionQueue(function(c,d,e){a.util.callback("onupgradeneeded",h,b),e()}),h.transaction.__oncomplete=function(){h.transaction=null;var b=a.util.createEvent("success");a.util.callback("onsuccess",h,b)}},f)},f):a.util.callback("onsuccess",h,k)},f)},f)},f)}var h=new a.IDBOpenDBRequest,i=!1;if(0===arguments.length)throw new TypeError("Database name is required");if(2===arguments.length&&(e=parseFloat(e),isNaN(e)||!isFinite(e)||0>=e))throw new TypeError("Invalid database version: "+e);return b+="",d.transaction(function(a){a.executeSql("SELECT * FROM dbVersions where name = ?",[b],function(a,c){0===c.rows.length?a.executeSql("INSERT INTO dbVersions VALUES (?,?)",[b,e||1],function(){g(0)},f):g(c.rows.item(0).version)},f)},f),h},b.prototype.deleteDatabase=function(b){function e(b){if(!h){g.readyState="done",g.error="DOMError";var c=a.util.createEvent("error");c.message=b,c.debug=arguments,a.util.callback("onerror",g,c),h=!0}}function f(){d.transaction(function(c){c.executeSql("DELETE FROM dbVersions where name = ? ",[b],function(){g.result=void 0;var b=a.util.createEvent("success");b.newVersion=null,b.oldVersion=i,a.util.callback("onsuccess",g,b)},e)},e)}var g=new a.IDBOpenDBRequest,h=!1,i=null;if(0===arguments.length)throw new TypeError("Database name is required");return b+="",d.transaction(function(d){d.executeSql("SELECT * FROM dbVersions where name = ?",[b],function(d,h){if(0===h.rows.length){g.result=void 0;var j=a.util.createEvent("success");return j.newVersion=null,j.oldVersion=i,void a.util.callback("onsuccess",g,j)}i=h.rows.item(0).version;var k=window.openDatabase(b,1,b,c);k.transaction(function(b){b.executeSql("SELECT * FROM __sys__",[],function(b,c){var d=c.rows;!function g(c){c>=d.length?b.executeSql("DROP TABLE __sys__",[],function(){f()},e):b.executeSql("DROP TABLE "+a.util.quote(d.item(c).name),[],function(){g(c+1)},function(){g(c+1)})}(0)},function(){f()})},e)})},e),g},b.prototype.cmp=function(b,c){return a.Key.encode(b)>a.Key.encode(c)?1:b===c?0:-1},a.shimIndexedDB=new b,a.IDBFactory=b}}(idbModules),function(a,b){function c(b,c){try{a[b]=c}catch(d){}if(a[b]!==c&&Object.defineProperty){try{Object.defineProperty(a,b,{value:c})}catch(d){}a[b]!==c&&a.console&&console.warn&&console.warn("Unable to shim "+b)}}"undefined"!=typeof a.openDatabase&&(c("shimIndexedDB",b.shimIndexedDB),a.shimIndexedDB&&(a.shimIndexedDB.__useShim=function(){c("indexedDB",b.shimIndexedDB),c("IDBFactory",b.IDBFactory),c("IDBDatabase",b.IDBDatabase),c("IDBObjectStore",b.IDBObjectStore),c("IDBIndex",b.IDBIndex),c("IDBTransaction",b.IDBTransaction),c("IDBCursor",b.IDBCursor),c("IDBKeyRange",b.IDBKeyRange),c("IDBRequest",b.IDBRequest),c("IDBOpenDBRequest",b.IDBOpenDBRequest),c("IDBVersionChangeEvent",b.IDBVersionChangeEvent)},a.shimIndexedDB.__debug=function(a){b.DEBUG=a})),"indexedDB"in a||(a.indexedDB=a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.oIndexedDB||a.msIndexedDB);var d=!1;if((navigator.userAgent.match(/Android 2/)||navigator.userAgent.match(/Android 3/)||navigator.userAgent.match(/Android 4\.[0-3]/))&&(navigator.userAgent.match(/Chrome/)||(d=!0)),"undefined"!=typeof a.indexedDB&&a.indexedDB&&!d||"undefined"==typeof a.openDatabase){
a.IDBDatabase=a.IDBDatabase||a.webkitIDBDatabase,a.IDBTransaction=a.IDBTransaction||a.webkitIDBTransaction,a.IDBCursor=a.IDBCursor||a.webkitIDBCursor,a.IDBKeyRange=a.IDBKeyRange||a.webkitIDBKeyRange,a.IDBTransaction||(a.IDBTransaction={});try{a.IDBTransaction.READ_ONLY=a.IDBTransaction.READ_ONLY||"readonly",a.IDBTransaction.READ_WRITE=a.IDBTransaction.READ_WRITE||"readwrite"}catch(e){}}else a.shimIndexedDB.__useShim()}(window,idbModules);
//# sourceMappingURL=indexeddbshim.min.js.map